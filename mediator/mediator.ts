// For future references:
// https://www.typescriptlang.org/play?ts=4.8.2#code/C4TwDgpgBAwgThAhsCBVAzhOMD2BbPRAOwBMoBeKAbwCgooJCBLAGwC4p1g4miBzANx0oYROnQB3HHBIcuPfkIC+QmmJBEAxlABmAVy3AmOIrATI0mbPkKkAEsRIssACk15ZZpCgxZcBRwBKamFNE3QcZwA6Fhw+FwAieG9ePihfOATAoXoEYD04U249CGUaGlBIKABxCGAM9ABFErgQCmoVcvUtXQNNIxMauobmrBAHUmc4FwBHDlr6qyaWkGDaXLqC03X6KD0ljgBtYV2Q09OmTwTLgFoARgSAGhPzokQ8CA4EgCk9FiZiFAAApYCAALwSL3oSme5zOcKgly+twATE8obs3h8vgBBEjvKAAZTwTGAAAtIXClC8ALrCTrUmhhIhcKAAfTCAVI6AA8nBRjwIOh2jsYAAlACiOIAKhK2ahCRKxRxkhYMv5bCQJk4sLCahLpfLFWLCWzGqglQBNebDJYC8aOKY0ToVcDQDWOXn8lpMIXtSoQHA6dmczVegW+9BCANQACSRDAemAAFlEGARVBDgBpRGmADWEBAQdgNk9fIjQppHCBiDg7zqWHQAB4Pdzyz6hdmaQA+Q4ABhpUE6MZ5ScTKbTGezuagBaLwdbJHDHfQVagYs2hWlbpbpbb3qwka73aHTPCwCgobLB8F6A4VEzOd4s8LxcXy8PlY4LlrfA48fHVMwC7YJyBPUdgEAtMuyHdoOT3Jd20-KNXSqZMIBIAFgGkJscwgAAPFBuRfecSy5RCb0jdo5zfBCP1vE9KAfQ4gRnLM1wfANq0eKBf3-BMkyAljByUIcu3KGNk3adDMOQaQhAAegAKigSSRReLioCSSUZTlBUlQSHJdj4rw1SsRdlCgAAfeF6E0hJqgNI0lVNc0rUMl4TIWEYVkspSFPKZlWUw9BRGATQyXaXCGEIiBiJohc6KQhiXE4t0eN-IcOBkrCcKzbtQO7UIksozsAxpH84D4QJyjUdANG0fRDGMIohWAFw1nKeggovBB0D+C9KEQCREFJKAQrCiLUo0t0vnFKVZWcsV0VOEydlORhRvYLTyQgTbWAAAWYFgok5FbzlEcQpBkL5dpEMRJGkEhKV2aloWyLqoAUhSoD6gaUU4MkcD+MgACNoAffZG3vLFPk4bhUgERFPHkVIxLpbrz1+oV-vaYbRovCbkCm9bVNmrTHMNfSTTNC0xUtc76DWt6hw+50gA
// https://www.typescriptlang.org/play?#code/KYDwDg9gTgLgBDAnmYcDCVgEMbAKoDOwUaEAtmVgHYAmcAvHAN4CwAUHHMJQJYA2ALjgEYUHlQDmAbnacwWAgQDu0GkJFjJMtgF9t7UJFhwFiKgGM4AMwCuFmDwhV0mHPiIlylWgAlqNPmIACnMyNRdsXEJiUgp-AEpmWThzJwIIQIA6PggJIIAiDEjxCThoqHz47U5MGBsoZ1EbYG0ddgNwaHgkFDgAcWAYcoIARWaoRAZmPXa2Qy6TAjNLW3tHZwGhj1HxxD9aQKgggEchTeGx4kRE1g44WvrnW85OG22hAG1kl6S7n84eOF8oCALQARnyABpvv8qFgyMAhPkAFI2Pg8ahwAAKxGAAC98jDODpoX8Xs9-gCgaCAExQokvOEIpEAQRo8LgAGUyDwYAALQlk4kwgC6yRmulmqSoIhSXn8BAA8lBLmJgAQphS0AAlACiLIAKrqAPp4Tm67VCIpucqxbw0fYBYikzh9XUG03m7Wc40jPAWgCaZ0GF12jsO7Al7B6qAAssAaBiYNAGMkAD6-SkxpE6-VGz0W-LVf5YKASIQxiBWCI2jx2-zh4hwDPWqJ1+W0YvCu4Zik-bNwfJuj1mi0+v2BosM0vlhDIYBV-oh7aqvb+Q7NpdbYg7K5duBRuadYyrcwOJxwRMEeQwcx8gA8Bq4IFwtA18cTOGgH3yMfyIoAPiCJgTDLSE516HQhF1F8oCwM97w-JNoHAkCByfHQAPiIRtUGR4DXne9K2rVI4jfZVVR4dUPgNQDM3uPCGjlMiaCVFVxioggPhjEUghnRYTCoa4BNwuoGgIlAiPnRcrxvO9HwAgDWlmdg+KWCw4CCRJ6AA+iAHo9LgXCCDReACD5CA0ToAAjVBrIgDJsCoZJpVlTATL4eBGCwJQsF5S8eGvHA72AmEB0KPVDRNUdtXpMkZyEPsXm4PzBEHflgBS-gAAFeD4TJSLiyl5EUFQoCBDK4BK5RVEFH42juHQqlmTgDIYjyYBpYQLKsuBbOYOA3h3RKmURYRRBKKQ4EBdQJskA8PjFO5XPgdzTK67zfP82Tgr5UKyXC4cC29X1-W1AMipeBLpnFZrdHiLTtCAA

import { register } from "./register.ts";

/**
 * We implement the mediator pattern by having an object handle both keys
 * and functions.
 *
 * Note, that you may like to create 2 objects. One for commands,
 * and the other for queries, as one of the purpose of this approach is
 * to optimize each action (Reads are 10x more frequent than writes and can
 * leverage a cache).
 *
 * The beauty of this, is that you can perform optimizations to the code in a central
 * place, and your actual business logic won't be affected.
 */

const _commandsOrQueries = register;

type CommandsOrQueries = typeof _commandsOrQueries;
type InputMap = {
  [K in keyof CommandsOrQueries]: Omit<
    Parameters<CommandsOrQueries[K]>[0],
    "ctx"
  >;
};
type OutputMap = {
  [K in keyof CommandsOrQueries]: ReturnType<CommandsOrQueries[K]>;
};
const commandsOrQueries: {
  [K in keyof CommandsOrQueries]: (arg: InputMap[K]) => OutputMap[K];
} = _commandsOrQueries as any;
type Mediator<K extends keyof CommandsOrQueries = keyof CommandsOrQueries> = {
  [P in K]: { type: P; arg: InputMap[P] };
}[K];

/**
 *
 * We then dispatch the function that we have stored by calling its key value.
 * This will create a separation of the code, slim your controllers, and reduce
 * dependencies.
 *
 * You could work out additional logic to make this dispatch pluggable.
 * For example, the logTime function down below works as a universal logger.
 * It will log all the commands and print out the time it started to execute.
 *
 * If you have a better typing definition, that'd be sick!
 * @param param0
 * @returns
 */
export const dispatch = <K extends keyof CommandsOrQueries>({
  type,
  arg,
}: Mediator<K>) => {
  logTime(type);
  return commandsOrQueries[type](arg);
};

function logTime(type: string | number | symbol) {
  const _type = typeof type === "symbol" ? String(type) : type;
  console.log("This is so powerful, every command can be logged!");
  console.log("This can create a plugin architecture!");
  console.log(`Starting ${_type} at ${Date.now()}`);
}
